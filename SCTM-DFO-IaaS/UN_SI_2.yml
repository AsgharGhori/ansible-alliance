---
# Called from Windows-Rollback.yml
# Includes all the tasks that fall under
# the Unclassed UN_SI_2 protocol requirements

# Imported vars: RegDefaultsPath RegistryDefaults

- name: UN_SI_2 ? > Check for UN_SI_2 defaults entry
  set_fact:
    HasUNSI2Def: "{{ 'UN_SI_2' in RegistryDefaults }}"

- name: UN_SI_2 = > Get keys if UN_SI_2 is not 'present'
  win_reg_stat:
    path: "{{ item.path }}"
    name: "{{ item.name }}"
  register: UN_SI2_DefKeys
  loop:
    - { taskID: A, path: 'HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer\Feeds', name: DisableIPSourceRouting }
    - { taskID: B, path: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Attachments', name: PreventOverride }
  when: not HasUNSI2Def

- name: UN_SI_2 + > Add keys to a dictionary
  set_fact:
    UN_SI_2_Def: "{{ UN_SI_2_Def|default({}) | combine( {item.item.taskID: (item.value if item.exists else 4294967295)} ) }}"
  loop: "{{ UN_SI2_DefKeys.results }}"
  when: not HasUNSI2Def

- name: UN_SI_2 ++ > Add dictionary to RegistryDefaults dictionary
  set_fact:
    RegistryDefaults: "{{ RegistryDefaults | combine({'UN_SI_2':UN_SI_2_Def}) }}"
  when: not HasUNSI2Def

- name: UN_SI_2 IO > Write dictionary
  win_copy:
    dest: "{{ RegDefaultsPath }}"
    content: "{{ RegistryDefaults }}"
  when: not HasUNSI2Def

# Tasks
- name: UN_SI_2 A > Prevent attachment downloads through RSS
  win_regedit:
    path: 'HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer\Feeds'
    name: DisableEnclosureDownload
    data: "{{ 1 if undo_UN_SI_2 is not defined else RegistryDefaults.UN_SI_2.A }}"
    type: dword
    state: "{{'absent' if undo_UN_SI_2 is defined and RegistryDefaults.UN_SI_2.A == 4294967295 else 'present'}}"
  when: skip_UN_SI_2_A is not defined

- name: UN_SI_2 B > Ensure attachments are scanned with antivirus
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Attachments
    name: ScanWithAntiVirus
    data: "{{ 3 if undo_UN_SI_2 is not defined else RegistryDefaults.UN_SI_2.B }}"
    type: dword
    state: "{{'absent' if undo_UN_SI_2 is defined and RegistryDefaults.UN_SI_2.B == 4294967295 else 'present'}}"
  when: skip_UN_SI_2_B is not defined