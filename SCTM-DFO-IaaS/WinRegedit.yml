# Task Script
# Contains Tasks for handling all windows registry
# editing required by a given Task Category
# (TaskCat: IA-5) within a specified Security
# Category (SecCat: UN).
# This should be called from a List Script

# Expected vars/facts:
# - MachineDefaults (populated)
# - SecCat
# - TaskCat
# - RegTask (many)
#   - ID
#   - RegPath
#   - RegName
#   - RegType
#   - Setting
#   - Desc
---
- name: "{{SecCat}}_{{TaskCat}} {{RegTask.TaskID}} > {{RegTask.Desc}}"
  win_regedit:
    path: "{{RegTask.RegPath}}"
    name: "{{RegTask.RegName}}"
    data: "{{ RegTask.Setting if (undo_{{SecCat}}_{{TaskCat}} is defined and MachineDefaults.{{SecCat}}_{{TaskCat}}.{{RegTask.ID}} }}"
    type: "{{RegTask.RegType}}"
    state: "{{'absent' if (undo_{{SecCat}}_{{TaskCat}} is defined and MachineDefaults.{{SecCat}}_{{TaskCat}}.{{RegTask.ID}} == 4294967295) else 'present'}}"
  when: "skip_{{SecCat}}_{{TaskCat}}_{{RegTask.ID}}"

# # Tasks
# - name: UN_SC-5 A > Set computer to restart for updates even if user(s) logged in
#   win_regedit:
#     path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
#     name: NoAutoRebootWithLoggedOnUsers
#     data: "{{ 0 if undo_UN_SC_5 is not defined else RegistryDefaults.UN_SC_5.A }}"
#     type: dword
#     state: "{{'absent' if (undo_UN_SC_5 is defined and RegistryDefaults.UN_SC_5.A == 4294967295) else 'present'}}"
#   when: skip_UN_SC_5_A is not defined