# == List Script ==
# Includes all the tasks that fall under
# the Unclassed AC-11 protocol requirements

# Expected vars/facts:
# - MachineDefaults {} (populated)
---
# Init task dictionaries
- name: Set AC-11 regedit task dictionary
  set_fact:
    UN_AC_11_RegTasks:
    - { Desc: Password-protect screen saver,
      ID: A, Value: 1, Type: string, Name: ScreenSaverIsSecure,
      Path: 'HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop' }
    - { Desc: Screen saver activates after 5 mins of inactivity,
      ID: B, Value: 600, Type: string, Name: ScreenSaverTimeOut,
      Path: 'HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop' }
    - { Desc: Require password when waking computer (AC),
      ID: C, Value: 1, Type: dword, Name: ACSettingIndex,
      Path: 'HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51' }
    - { Desc: Require password when waking computer (DC),
      ID: D, Value: 1, Type: dword, Name: DCSettingIndex,
      Path: 'HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51' }

# Init and get defaults
- name: Check if defaults for AC-11 were loaded
  set_fact:
    Loaded_UN_AC_11: "{{ 'UN_AC_11' in MachineDefaults }}"

- name: Initialize UndoList
  set_fact:
    UndoList: "{{ UndoList + ['UN_AC_11_'+item.ID] }}"
  loop: "{{ UN_AC_11_RegTasks }}"
  when: "'UN_AC_11' in UndoList"

- name: Get AC-7 regedit defaults
  include_tasks: WinRegStat.yml
  vars:
    SecCat: UN
    TaskCat: AC_11
    RegTasks: "{{ UN_AC_11_RegTasks }}"
  when: not Loaded_UN_AC_11

# Run tasks
- name: Run AC-7 regedit tasks
  include_tasks: WinRegedit.yml
  vars:
    SecCat: UN
    TaskCat: AC_11
  loop: "{{ UN_AC_11_RegTasks }}"
  loop_control:
    loop_var: RegTask

# OLD
# - name: UN_AC_11 ? > Check for UN_AC_11 defaults entry
#   set_fact:
#     HasUNAC11Def: "{{ 'UN_AC_11' in RegistryDefaults }}"

# - name: UN_AC_11 = > Get keys in UN_AC_11 is not 'present'
#   win_reg_stat:
#     path: "{{ item.path }}"
#     name: "{{ item.name }}"
#   register: UN_AC11_DefKeys
#   loop:
#     - { ID: A, path: 'HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop', name: ScreenSaverIsSecure }
#     - { ID: B, path: 'HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop', name: ScreenSaverTimeOut }
#     - { ID: C, path: 'HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51', name: ACSettingIndex }
#     - { ID: D, path: 'HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51', name: DCSettingIndex }
#   when: not HasUNAC11Def

# - name: UN_AC_11 + > Add keys to a dictionary
#   set_fact:
#     UN_AC_11_Def: "{{ UN_AC_11_Def|default({}) | combine( {item.item.ID: (item.value if item.exists else 4294967295)} ) }}"
#   loop: "{{ UN_AC11_DefKeys.results }}"
#   when: not HasUNAC11Def

# - name: UN_AC_11 ++ > Add dictionary to RegistryDefaults dictionary
#   set_fact:
#     RegistryDefaults: "{{ RegistryDefaults | combine({'UN_AC_11':UN_AC_11_Def}) }}"
#   when: not HasUNAC11Def

# - name: UN_AC_11 IO > Write dictionary
#   win_copy:
#     dest: "{{ RegDefaultsPath }}"
#     content: "{{ RegistryDefaults }}"
#   when: not HasUNAC11Def

# # Tasks
# - name: UN_AC_11 A > Password-protect screen saver
#   win_regedit:
#     path: HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop
#     name: ScreenSaverIsSecure
#     data: "{{ 1 if undo_UN_AC_11 is not defined else RegistryDefaults.UN_AC_11.A }}"
#     type: string
#     state: "{{'absent' if (undo_UN_AC_11 is defined and RegistryDefaults.UN_AC_11.A == 4294967295) else 'present'}}"
#   when: skip_UN_AC_11_A is not defined

# - name: UN_AC_11 B > Screen saver activates after 5 mins of inactivity
#   win_regedit:
#     path: HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop
#     name: ScreenSaverTimeOut
#     data: "{{ 600 if undo_UN_AC_11 is not defined else RegistryDefaults.UN_AC_11.B }}"
#     type: string
#     state: "{{'absent' if (undo_UN_AC_11 is defined and RegistryDefaults.UN_AC_11.B == 4294967295) else 'present'}}"
#   when: skip_UN_AC_11_B is not defined

# - name: UN_AC_11 C > Require password when waking computer (AC)
#   win_regedit:
#     path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51
#     name: ACSettingIndex
#     data: "{{ 1 if undo_UN_AC_11 is not defined else RegistryDefaults.UN_AC_11.C }}"
#     type: dword
#     state: "{{'absent' if (undo_UN_AC_11 is defined and RegistryDefaults.UN_AC_11.C == 4294967295) else 'present'}}"
#   when: skip_UN_AC_11_C is not defined

# - name: UN_AC_11 D > Require password when waking computer (DC)
#   win_regedit:
#     path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51
#     name: DCSettingIndex
#     data: "{{ 1 if undo_UN_AC_11 is not defined else RegistryDefaults.UN_AC_11.D }}"
#     type: dword
#     state: "{{'absent' if (undo_UN_AC_11 is defined and RegistryDefaults.UN_AC_11.D == 4294967295) else 'present'}}"
#   when: skip_UN_AC_11_D is not defined