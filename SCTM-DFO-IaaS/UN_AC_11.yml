---
# Called from Windows-Rollback.yml
# Includes all the tasks that fall under
# the Unclassed UN_AC_11 protocol requirements

# Imported vars: RegDefaultsPath RegistryDefaults

- name: UN_AC_11 ? > Check for UN_AC_11 defaults entry
  set_fact:
    HasUNAC11Def: "{{ 'UN_AC_11' in RegistryDefaults }}"

- name: UN_AC_11 = > Get keys in UN_AC_11 is not 'present'
  win_reg_stat:
    path: "{{ item.path }}"
    name: "{{ item.name }}"
  register: UN_AC11_DefKeys
  loop:
    - { ID: A, path: 'HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop', name: ScreenSaverIsSecure }
    - { ID: B, path: 'HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop', name: ScreenSaverTimeOut }
    - { ID: C, path: 'HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51', name: DCSettingIndex }
    - { ID: D, path: 'HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51', name: ACSettingIndex }
  when: not HasUNAC11Def

- name: UN_AC_11 + > Add keys to a dictionary
  set_fact:
    UN_AC_11_Def: "{{ UN_AC_11_Def|default({}) | combine( {item.item.ID: (item.value if item.exists else 4294967295)} ) }}"
  loop: "{{ UN_AC11_DefKeys.results }}"
  when: not HasUNAC11Def

- name: UN_AC_11 ++ > Add dictionary to RegistryDefaults dictionary
  set_fact:
    RegistryDefaults: "{{ RegistryDefaults | combine({'UN_AC_11':UN_AC_11_Def}) }}"
  when: not HasUNAC11Def

- name: UN_AC_11 IO > Write dictionary
  win_copy:
    dest: "{{ RegDefaultsPath }}"
    content: "{{ RegistryDefaults }}"
  when: not HasUNAC11Def

# Tasks
- name: UN_AC_11 A > Password-protect screen saver
  win_regedit:
    path: HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop
    name: ScreenSaverIsSecure
    data: "{{ 1 if undo_UN_AC_11 is not defined else RegistryDefaults.UN_AC_11.A }}"
    type: string
    state: "{{'absent' if (undo_UN_AC_11 is defined and RegistryDefaults.UN_AC_11.A == 4294967295) else 'present'}}"
  when: skip_UN_AC_11_A is not defined

- name: UN_AC_11 B > Screen saver activates after 5 mins of inactivity
  win_regedit:
    path: HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop
    name: ScreenSaverTimeOut
    data: "{{ 600 if undo_UN_AC_11 is not defined else RegistryDefaults.UN_AC_11.B }}"
    type: string
    state: "{{'absent' if (undo_UN_AC_11 is defined and RegistryDefaults.UN_AC_11.B == 4294967295) else 'present'}}"
  when: skip_UN_AC_11_B is not defined

- name: UN_AC_11 > Require password when waking computer (DC)
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51
    name: DCSettingIndex
    data: "{{ 1 if undo_UN_AC_11 is not defined else RegistryDefaults.UN_AC_11.C }}"
    type: dword
    state: "{{'absent' if (undo_UN_AC_11 is defined and RegistryDefaults.UN_AC_11.C == 4294967295) else 'present'}}"
  when: skip_UN_AC_11_C is not defined

- name: UN_AC_11 > Require password when waking computer (AC)
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51
    name: ACSettingIndex
    data: "{{ 1 if undo_UN_AC_11 is not defined else RegistryDefaults.UN_AC_11.D }}"
    type: dword
    state: "{{'absent' if (undo_UN_AC_11 is defined and RegistryDefaults.UN_AC_11.D == 4294967295) else 'present'}}"
  when: skip_UN_AC_11_D is not defined