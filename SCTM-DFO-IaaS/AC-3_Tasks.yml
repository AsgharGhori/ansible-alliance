---
# Called from Windows-Unclassed.yml
# Includes all the tasks that fall under
# the AC-3 protocol requirements

- name: AC-3 A > Restrict use of blank passwords
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
    name: LimitBlankPasswordUse
    data: 1
    type: dword

- name: AC-3 B > Prevent printer driver installation for non-admins
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Print\Providers\LanMan Print Services\Servers
    name: AddPrinterDrivers
    data: 1
    type: dword

- name: AC-3 C > Enforce encrypted or signed channel data
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
    name: "{{ item }}"
    data: 1
    type: dword
  loop:
    - RequireSignOrSeal
    - SignSecureChannel
  when: AC_3 or CM_3

- name: AC-3 D > Do not display last user name
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: dontdisplaylastusername
    data: 1
    type: dword

- name: AC-3 E > Require CTRL + ALT + DEL to logon
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: disabledcad
    data: 1
    type: dword

- name: AC-3 F > Enforce digital signing of communications (Workstation)
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters
    name: EnableSecuritySignature
    data: 1
    type: dword

- name: AC-3 G > Enforce digital signing of communications (Server)
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters
    name: enablesecuritysignature
    data: 1
    type: dword

- name: AC-3 H > Allow SafeDLL search mode
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager
    name: SafeDllSearchMode
    data: 1
    type: dword

- name: AC-3 I > Set screen saver grace period to 4
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
    name: ScreenSaverGracePeriod
    data: 4
    type: string

- name: AC-3 J > Prevent SAM account searching
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
    name: restrictanonymoussam
    data: 1
    type: dword

- name: AC-3 K > Restrict anonymous user permissions
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
    name: everyoneincludesanonymous
    data: 0
    type: dword

- name: AC-3 L > Restrict anonymous access to pipes
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters
    name: restrictnullsessaccess
    data: 1
    type: dword

- name: AC-3 M > Enforce LDAP client signing
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\ldap
    name: ldapclientintegrity
    data: 1
    type: dword

- name: AC-3 N > Allow system shutdown without logon
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: shutdownwithoutlogon
    data: 0
    type: dword

- name: AC-3 O > Prevent unsecure elevation prompts from applications
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableUIADesktopToggle
    data: 0
    type: dword

- name: AC-3 P > Prevent application installation without prompt
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableInstallerDetection
    data: 1
    type: dword

- name: AC-3 Q > Run admins in Admin Approval Mode
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableLUA
    data: 1
    type: dword

- name: AC-3 R > Enforce secure desktop for elevation prompts
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: PromptOnSecureDesktop
    data: 1
    type: dword

- name: AC-3 S > Restrict legacy application registry write locations
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableVirtualization
    data: 1
    type: dword

# The following tasks are by Kevin's security_policy.yml and
# security_policy.inf.jinja scripts
# AC-3 > Prohibit anything from acting as the Operating System
# AC-3 > Allow local logon to Admins
# AC-3 > Restrict system time changes to Admins and Local Service
# AC-3 > Restrict creating pagefiles to Admins
# AC-3 > Restrict creating symbolic links to Admins
# AC-3 > Prohibit network access to computer for Guests and Local Account
# AC-3 > Prohibit local logon for Guests
# AC-3 > Restrict remote shutdown to Admins
# AC-3 > Restrict generating security audits to Local Service and Network Service
# AC-3 > Restrict client impersonation to 
#     Administrators, SERVICE, Local Service, Network Service
# AC-3 > Restrict scheduling priority to Admins
# AC-3 > Restrict device driver loading to Admins
# AC-3 > Restrict managing audits and security logs to Admins
# AC-3 > Prohibit modifying object labels for everyone
# AC-3 > Restrict modifying firmware environment to Admins
# AC-3 > Restrict volume maintenance to Admins
# AC-3 > Restrict profiling performance to Admins, NT Service, and WdiServiceHost
# AC-3 > Restrict file and dir restoration to Admins
# AC-3 > Restrict shutdown to Admins
# AC-3 > Prohibit RDP logon for Guests

- name: AC-3 T > Prevent Microsoft accounts from logging in
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: noconnecteduser
    data: 3
    type: dword

- name: AC-3 U >Prohibit server controllers from scheduling tasks
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
    name: submitcontrol
    data: 0
    type: dword

- name: AC-3 V > Prohibit anonymous access to names pipes
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters
    name: NullSessionPipes
    data: ""
    type: multistring

- name: AC-3 W > Prohibit anonymous access to session shares
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters
    name: NullSessionShares
    data: ""
    type: multistring

- name: AC-3 X > Prevent last user's credentials from being stored
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: DisableAutomaticRestartSignOn
    data: 1
    type: dword

- name: AC-3 Y > Require authentication for RPC service access
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Rpc
    name: EnableAuthEpResolution
    data: 1
    type: dword

- name: AC-3 Z > Require Domain Controller Authentication to unlock computer
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon
    name: ForceUnlockLogon
    data: 1
    type: dword