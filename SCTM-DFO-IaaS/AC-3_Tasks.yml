---
# Called from Windows-Unclassed.yml
# Includes all the tasks that fall under
# the AC-3 protocol requirements

## Task template
# - name: AC-3 >
#   win_regedit:
#     path: 
#     name: 
#     data: 
#     type: 

- name: AC-3 A > Restrict use of blank passwords
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
    name: LimitBlankPasswordUse
    data: 1
    type: dword

- name: AC-3 B > Prevent printer driver installation for non-admins
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Print\Providers\LanMan Print Services\Servers
    name: AddPrinterDrivers
    data: 1
    type: dword

- name: AC-3 C > Enforce encrypted or signed channel data
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
    name: "{{ item }}"
    data: 1
    type: dword
  loop:
    - RequireSignOrSeal
    - SignSecureChannel
  when: AC_3 or CM_3

- name: AC-3 D > Do not display last user name
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: dontdisplaylastusername
    data: 1
    type: dword

- name: AC-3 E > Require CTRL + ALT + DEL to logon
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: disabledcad
    data: 1
    type: dword

- name: AC-3 F > Enforce digital signing of communications (Workstation)
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters
    name: EnableSecuritySignature
    data: 1
    type: dword

- name: AC-3 G > Enforce digital signing of communications (Server)
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters
    name: enablesecuritysignature
    data: 1
    type: dword

- name: AC-3 H > Allow SafeDLL search mode
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager
    name: SafeDllSearchMode
    data: 1
    type: dword

- name: AC-3 I > Set screen saver grace period to 4
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
    name: ScreenSaverGracePeriod
    data: 4
    type: string

- name: AC-3 J > Prevent SAM account searching
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
    name: restrictanonymoussam
    data: 1
    type: dword

- name: AC-3 K > Restrict anonymous user permissions
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
    name: everyoneincludesanonymous
    data: 0
    type: dword

- name: AC-3 L > Restrict anonymous access to pipes
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters
    name: restrictnullsessaccess
    data: 1
    type: dword

- name: AC-3 M > Enforce LDAP client signing
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\ldap
    name: ldapclientintegrity
    data: 1
    type: dword

- name: AC-3 N > Allow system shutdown without logon
  win_regedit:
    path: 
    name: 
    data: 
    type: 

- name: AC-3 O > Prevent unsecure elevation prompts from applications
  win_regedit:
    path: 
    name: 
    data: 
    type: 

- name: AC-3 P > Prevent application installation without prompt
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableInstallerDetection
    data: 1
    type: dword

- name: AC-3 Q > Run admins in Admin Approval Mode
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableLUA
    data: 1
    type: dword

- name: AC-3 R > Enforce secure desktop for elevation prompts
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: PromptOnSecureDesktop
    data: 1
    type: dword

- name: AC-3 S > Restrict legacy application registry write locations
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableVirtualization
    data: 1
    type: dword

# Check users 
- name: AC-3 T > Prohibit users from acting as the Operating System
  win_user_right:
    name: SeTcbPrivilege
    users:
    - SYSTEM
    action: add

- name: AC-3 U > Allow Admins to log on locally
  win_user_right:
    name: SeInteractiveLogonRight
    users:
    - Administrators
    action: add

# - name: AC-3 >
#   win_regedit:
#     path: 
#     name: 
#     data: 
#     type: 

- name: AC-3 Y > Require authentication for RPC service access
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Rpc
    name: EnableAuthEpResolution
    data: 1
    type: dword

- name: AC-3 Z > Require Domain Controller Authentication to unlock computer
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon
    name: ForceUnlockLogon
    data: 1
    type: dword