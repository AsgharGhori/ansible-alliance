---
# Called from Windows-Rollback.yml
# Includes all the tasks that fall under
# the Unclassed UN_AU_9 protocol requirements

# Imported vars: RegDefaultsPath RegistryDefaults

- name: UN_AU_9 ? > Check for UN_AU_9 defaults entry
  set_fact:
    HasUNAU9Def: "{{ 'UN_AU_9' in RegistryDefaults }}"

- name: UN_AU_9 = > Get keys in UN_AU_9 is not 'present'
  win_reg_stat:
    path: "{{ item.path }}"
    name: LogFilePath
  register: UN_AU9_DefKeys
  loop:
    - { ID: A, path: 'HKLM:\Software\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging' }
    - { ID: B, path: 'HKLM:\Software\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging' }
    - { ID: C, path: 'HKLM:\Software\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging' }
  when: not HasUNAU9Def

- name: UN_AU_9 + > Add keys to a dictionary
  set_fact:
    UN_AU_9_Def: "{{ UN_AU_9_Def|default({}) | combine( {item.item.ID: (item.value if item.exists else 4294967295)} ) }}"
  loop: "{{ UN_AU9_DefKeys.results }}"
  when: not HasUNAU9Def

- name: UN_AU_9 ++ > Add dictionary to RegistryDefaults dictionary
  set_fact:
    RegistryDefaults: "{{ RegistryDefaults | combine({'UN_AU_9':UN_AU_9_Def}) }}"
  when: not HasUNAU9Def

- name: UN_AU_9 IO > Write dictionary
  win_copy:
    dest: "{{ RegDefaultsPath }}"
    content: "{{ RegistryDefaults }}"
  when: not HasUNAU9Def

# Tasks
- name: UN_AU_9 A > Ensure firewalls log to correct files
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging
    name: LogFilePath
    data: "{{ '%SYSTEMROOT%\\System32\\logfiles\\firewall\\domainfw.log' if undo_UN_AU_9 is not defined else RegistryDefaults.UN_AU_9.A }}"
    type: string
    state: "{{'absent' if (undo_UN_AU_9 is defined and RegistryDefaults.UN_AU_9.A == 4294967295) else 'present'}}"
  when: skip_UN_AU_9_A is not defined

- name: UN_AU_9 B > Ensure firewalls log to correct files
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging
    name: LogFilePath
    data: "{{ '%SYSTEMROOT%\\System32\\logfiles\\firewall\\privatefw.log' if undo_UN_AU_9 is not defined else RegistryDefaults.UN_AU_9.B }}"
    type: string
    state: "{{'absent' if (undo_UN_AU_9 is defined and RegistryDefaults.UN_AU_9.B == 4294967295) else 'present'}}"
  when: skip_UN_AU_9_B is not defined

- name: UN_AU_9 C > Ensure firewalls log to correct files
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging
    name: LogFilePath
    data: "{{ '%SYSTEMROOT%\\System32\\logfiles\\firewall\\publicfw.log' if undo_UN_AU_9 is not defined else RegistryDefaults.UN_AU_9.C }}"
    type: string
    state: "{{'absent' if (undo_UN_AU_9 is defined and RegistryDefaults.UN_AU_9.C == 4294967295) else 'present'}}"
  when: skip_UN_AU_9_C is not defined