# == List Script ==
# Includes all the tasks that fall under
# the Unclassed AU-3 protocol requirements

# Expected vars/facts:
# - MachineDefaults {} (populated)
---
# Init task dictionaries
- name: Set AU-3 regedit task dictionary
  set_fact:
    UN_AU_3_RegTasks:
    - { Desc: Ensure firewalls log dropped packets (domain),
      ID: A, Value: 1, Type: dword, Name: LogDroppedPackets,
      Path: 'HKLM:\Software\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging' } # 4294967295
    - { Desc: Ensure firewalls log dropped packets (private),
      ID: B, Value: 1, Type: dword, Name: LogDroppedPackets,
      Path: 'HKLM:\Software\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging' } # 4294967295
    - { Desc: Ensure firewalls log dropped packets (public),
      ID: C, Value: 1, Type: dword, Name: LogDroppedPackets,
      Path: 'HKLM:\Software\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging' } # 4294967295

# Init and get defaults
- name: Check if defaults for AU-3 were loaded
  set_fact:
    Loaded_UN_AU_3: "{{ 'UN_AU_3' in MachineDefaults }}"

- name: Initialize UndoList
  set_fact:
    UndoList: "{{ UndoList + ['UN_AU_3_'+item.ID] }}"
  loop: "{{ UN_AU_3_RegTasks }}"
  when: "'UN_AU_3' in UndoList"

- name: Get AU-3 regedit defaults
  include_tasks: WinRegStat.yml
  vars:
    SecCat: UN
    TaskCat: AU_3
    RegTasks: "{{ UN_AU_3_RegTasks }}"
  when: not Loaded_UN_AU_3

# Run tasks
- name: Run AU-3 regedit tasks
  include_tasks: WinRegedit.yml
  vars:
    SecCat: UN
    TaskCat: AU_3
  loop: "{{ UN_AU_3_RegTasks }}"
  loop_control:
    loop_var: RegTask

# OLD
# - name: UN_AU_3 ? > Check for UN_AU_3 defaults entry
#   set_fact:
#     HasUNAU3Def: "{{ 'UN_AU_3' in RegistryDefaults }}"

# - name: UN_AU_3 = > Get keys in UN_AU_3 is not 'present'
#   win_reg_stat:
#     path: "{{ item.path }}"
#     name: LogDroppedPackets
#   register: UN_AU3_DefKeys
#   loop:
#     - { ID: A, path: 'HKLM:\Software\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging' }
#     - { ID: B, path: 'HKLM:\Software\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging' }
#     - { ID: C, path: 'HKLM:\Software\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging' }
#   when: not HasUNAU3Def

# - name: UN_AU_3 + > Add keys to a dictionary
#   set_fact:
#     UN_AU_3_Def: "{{ UN_AU_3_Def|default({}) | combine( {item.item.ID: (item.value if item.exists else 4294967295)} ) }}"
#   loop: "{{ UN_AU3_DefKeys.results }}"
#   when: not HasUNAU3Def

# - name: UN_AU_3 ++ > Add dictionary to RegistryDefaults dictionary
#   set_fact:
#     RegistryDefaults: "{{ RegistryDefaults | combine({'UN_AU_3':UN_AU_3_Def}) }}"
#   when: not HasUNAU3Def

# - name: UN_AU_3 IO > Write dictionary
#   win_copy:
#     dest: "{{ RegDefaultsPath }}"
#     content: "{{ RegistryDefaults }}"
#   when: not HasUNAU3Def

# # Tasks
# - name: UN_AU_3 A > Ensure firewalls log dropped packets
#   win_regedit:
#     path: HKLM:\Software\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging
#     name: LogDroppedPackets
#     data: "{{ 1 if undo_UN_AU_3 is not defined else RegistryDefaults.UN_AU_3.A }}"
#     type: dword
#     state: "{{'absent' if (undo_UN_AU_3 is defined and RegistryDefaults.UN_AU_3.A == 4294967295) else 'present'}}"
#   when: skip_UN_AU_3_A is not defined

# - name: UN_AU_3 B > Ensure firewalls log dropped packets
#   win_regedit:
#     path: HKLM:\Software\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging
#     name: LogDroppedPackets
#     data: "{{ 1 if undo_UN_AU_3 is not defined else RegistryDefaults.UN_AU_3.B }}"
#     type: dword
#     state: "{{'absent' if (undo_UN_AU_3 is defined and RegistryDefaults.UN_AU_3.B == 4294967295) else 'present'}}"
#   when: skip_UN_AU_3_B is not defined

# - name: UN_AU_3 C > Ensure firewalls log dropped packets
#   win_regedit:
#     path: HKLM:\Software\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging
#     name: LogDroppedPackets
#     data: "{{ 1 if undo_UN_AU_3 is not defined else RegistryDefaults.UN_AU_3.C }}"
#     type: dword
#     state: "{{'absent' if (undo_UN_AU_3 is defined and RegistryDefaults.UN_AU_3.C == 4294967295) else 'present'}}"
#   when: skip_UN_AU_3_C is not defined