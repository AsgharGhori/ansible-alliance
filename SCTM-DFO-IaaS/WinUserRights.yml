# Task Script
# Contains Tasks for handling all windows registry
# editing. Called from a List Script

# Expected vars/facts:
# - MachineDefaults {} (populated and with SecCat_TaskCat: {} entry)
# - Rollbacks []
# - Skips []
# - SecCat
# - TaskCat
# - RightsTask {} (many)
#   - ID
#   - Name
#   - Users []
#   - Desc
---
- set_fact:
    skipVar: "{{ SecCat+'_'+TaskCat+'_'+RightsTask.ID }}"
    defEntry: "{{ SecCat+'_'+TaskCat }}"

- name: "{{SecCat+'_'+TaskCat+' '+RightsTask.ID+' > '+RightsTask.Desc}}"
  win_user_right:
    name: "{{RightsTask.Name}}"
    users: "{{RightsTask.Users}}"
    action: set
  register: UserDelta
  when: skipVar not in Skips

- name: Set default users if not set
  set_fact:
    MachineDefaults: "{{ MachineDefaults[SecCat+'_'+TaskCat] |combine({
    RightsTask.ID: RightsTask.Users |union(UserDelta.removed)
    |difference(UserDelta.added)}) }}"
  when: skipVar not in Skips and RightsTask.ID not in MachineDefaults[defEntry]