# Task Script
# Contains Tasks for handling all windows registry
# editing. Called from a List Script

# Expected vars/facts:
# - MachineDefaults {} (populated and with SecCat_TaskCat: {} entry)
# - Rollbacks []
# - Skips []
# - SecCat
# - TaskCat
# - RightsTasks [{}] (one object)
#   - ID
#   - Name
#   - Users []
#   - Desc
---
- set_fact:
    defEntry: "{{ SecCat+'_'+TaskCat }}"

- name: Initialize dictionary user rights defaults
  set_fact:
    MachineDefaults: "{{ MachineDefaults | combine(defEntry: {}) }}"
  when: "not defEntry in MachineDefaults"

# Get skips

- name: "{{defEntry+' user rights tasks'}}"
  win_user_right:
    name: "{{item.Name}}"
    users: "{{item.Users}}"
    action: set
  register: UserDelta
  loop: "{{ RightsTasks }}"

- name: Add default users into a dictionary
  set_fact:
    defaultUsers: "{{ defaultUsers|default({}) |combine({
      item.item.ID: item.item.Users |union(item.removed)
      |difference(item.added) }) }}"
  loop: "{{ UserDelta.results }}"
# Apply skips

- debug:
    var: defaultUsers

- debug:
    var: MachineDefaults

- name: Add default users dictionary to MachineDefaults
  set_fact:
    MachineDefaults: "{{ MachineDefaults |combine(defaultUsers) }}"

- name: Write to MachineDefaults file
  win_copy:
    dest: "{{ MachineDefaultsPath }}"
    content: "{{ MachineDefaults }}"