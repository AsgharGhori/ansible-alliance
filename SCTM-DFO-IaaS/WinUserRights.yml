# Task Script
# Contains Tasks for handling all windows registry
# editing. Called from a List Script

# Expected vars/facts:
# - MachineDefaults {} (populated and with SecCat_TaskCat: {} entry)
# - Rollbacks []
# - Skips []
# - SecCat
# - TaskCat
# - RightsTasks [{}] (one object)
#   - ID
#   - Name
#   - Users []
#   - Desc
---
- set_fact:
    Sec_Task: "{{ SecCat+'_'+TaskCat }}"

- name: Initialize dictionary user rights defaults
  set_fact:
    MachineDefaults: "{{ MachineDefaults | combine(Sec_Task: {}) }}"
  when: "not Sec_Task in MachineDefaults"

- name: Load which tasks to skip
  set_fact:
    SkipIDs: "{{ SkipIDs|default([]) + [item.lstrip(Sec_Task+'_')]
      if Sec_Task in item else SkipIDs|default([]) }}"
  loop: "{{ Skips }}"

- name: "{{Sec_Task+' user rights tasks'}}"
  win_user_right:
    name: "{{item.Name}}"
    users: "{{item.Users if Sec_Task not in Rollbacks and
      item.ID not in MachineDefaults[Sec_Task] else
      MachineDefaults[Sec_Task][item.ID] }}"
    action: set
  register: UserDelta
  loop: "{{ RightsTasks }}"

- name: Add default users into a temp dictionary
  set_fact:
    defaultUsers: "{{ defaultUsers|default({}) |combine({
      item.item.ID: item.item.Users |union(item.removed)
      |difference(item.added) }) }}"
  loop: "{{ UserDelta.results }}"
  when: not item.item.ID in SkipIDs

- name: Add default users dictionary to MachineDefaults
  set_fact:
    MachineDefaults: "{{ MachineDefaults |combine({ Sec_Task:
      MachineDefaults[Sec_Task] |combine(defaultUsers) }) }}"

- name: Write to MachineDefaults file
  win_copy:
    dest: "{{ MachineDefaultsPath }}"
    content: "{{ MachineDefaults }}"