# == List Script ==
# Includes all the tasks that fall under
# the Unclassed SC-5 protocol requirements

# Expected vars/facts:
# - MachineDefaults {} (populated)
---
# Init task dictionaries
- name: Set SC-5 regedit task dictionary
  set_fact:
    UN_SC_5_RegTasks:
    - { Desc: Set computer to restart for updates even if user(s) logged in,
      ID: A, Value: 0, Type: dword, Name: NoAutoRebootWithLoggedOnUsers,
      Path: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' }
    - { Desc: Limit unacknowledged data retransmission (IPv6),
      ID: B, Value: 3, Type: dword, Name: TcpMaxDataRetransmissions,
      Path: 'HKLM:\SYSTEM\CurrentControlSet\Services\TCPIP6\Parameters' }
    - { Desc: Limit unacknowledged data retransmission (IPv4),
      ID: C, Value: 3, Type: dword, Name: TcpMaxDataRetransmissions,
      Path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' }
    - { Desc: Set keep-alive packet send interval,
      ID: D, Value: 30000, Type: dword, Name: KeepAliveTime,
      Path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' }
    - { Desc: Disable IRDP Default Gateway configuration,
      ID: E, Value: 0, Type: dword, Name: PerformRouterDiscovery,
      Path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' }

- name: Set SC-5 user rights task dictionary
  set_fact:
    UN_SC_5_RightsTasks:
    - { Desc: "Allow process memory quota adjustments for Admins, Local and Network Service",
      ID: F, Name: SeIncreaseQuotaPrivilege, 
      Users: ['Administrators','Local Service','Network Service'] }
    - { Desc: "Restrict sympolic link creation to Admins",
      ID: G, Name: SeCreateSymbolicLinkPrivilege, 
      Users: ['Administrators'] }
    - { Desc: "Restrict firmware environment value changes to Admins",
      ID: H, Name: SeSystemEnvironmentPrivilege, 
      Users: ['Administrators'] }
    - { Desc: "Restrict volume maintenance tasks to Admins",
      ID: I, Name: SeManageVolumePrivilege, 
      Users: ['Administrators'] }
    - { Desc: "Restrict file and directory retsoration to Admins",
      ID: J, Name: SeRestorePrivilege, 
      Users: ['Administrators'] }

# Init and get defaults
- name: Check if defaults were loaded for UN_AC_3 were loaded
  set_fact:
    Loaded_UN_SC_5: "{{ 'UN_SC_5' in MachineDefaults }}"

- name: Initialize UndoList
  set_fact:
    UndoList: "{{ UndoList + ['UN_SC_5_'+item.ID] }}"
  loop: "{{ UN_SC_5_RegTasks |union(UN_SC_5_RightsTasks) }}"
  when: "'UN_SC_5' in UndoList"

- name: Get regedit defaults
  include_tasks: WinRegStat.yml
  vars:
    SecCat: UN
    TaskCat: SC_5
    RegTasks: "{{ UN_SC_5_RegTasks }}"
  when: not Loaded_UN_SC_5

# Run tasks
- name: Run regedit tasks
  include_tasks: WinRegedit.yml
  vars:
    SecCat: UN
    TaskCat: SC_5
  loop: "{{ UN_SC_5_RegTasks }}"
  loop_control:
    loop_var: RegTask

- name: Run user rights tasks # simultaneously saves defaults
  include_tasks: WinUserRights.yml
  vars:
    SecCat: UN
    TaskCat: SC_5
    Loaded: Loaded_UN_SC_5
    RightsTasks: "{{ UN_SC_5_RightsTasks }}"

# # Old
# - name: UN_SC_5 ? > Check for UN_SC_5 defaults entry
#   set_fact:
#     HasUNSC5Def: "{{ 'UN_SC_5' in RegistryDefaults }}"

# - name: UN_SC_5 = > Get keys if UN_SC_5 is not 'present'
#   win_reg_stat:
#     path: "{{ item.path }}"
#     name: "{{ item.name }}"
#   register: UN_SC5_DefKeys
#   loop:
#     - { taskID: A, path: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU', name: NoAutoRebootWithLoggedOnUsers }
#     - { taskID: B, path: 'HKLM:\SYSTEM\CurrentControlSet\Services\TCPIP6\Parameters', name: TcpMaxDataRetransmissions }
#     - { taskID: C, path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters', name: TcpMaxDataRetransmissions }
#     - { taskID: D, path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters', name: KeepAliveTime }
#     - { taskID: E, path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters', name: PerformRouterDiscovery }
#   when: not HasUNSC5Def

# - name: UN_SC_5 + > Add keys to a dictionary
#   set_fact:
#     UN_SC_5_Def: "{{ UN_SC_5_Def|default({}) | combine( {item.item.taskID: (item.value if item.exists else 4294967295)} ) }}"
#   loop: "{{ UN_SC5_DefKeys.results }}"
#   when: not HasUNSC5Def

# - name: UN_SC_5 ++ > Add dictionary to RegistryDefaults dictionary
#   set_fact:
#     RegistryDefaults: "{{ RegistryDefaults | combine({'UN_SC_5':UN_SC_5_Def}) }}"
#   when: not HasUNSC5Def

# - name: UN_SC_5 IO > Write dictionary
#   win_copy:
#     dest: "{{ RegDefaultsPath }}"
#     content: "{{ RegistryDefaults }}"
#   when: not HasUNSC5Def

# # Tasks
# - name: UN_SC-5 A > Set computer to restart for updates even if user(s) logged in
#   win_regedit:
#     path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
#     name: NoAutoRebootWithLoggedOnUsers
#     data: "{{ 0 if undo_UN_SC_5 is not defined else RegistryDefaults.UN_SC_5.A }}"
#     type: dword
#     state: "{{'absent' if (undo_UN_SC_5 is defined and RegistryDefaults.UN_SC_5.A == 4294967295) else 'present'}}"
#   when: skip_UN_SC_5_A is not defined

# - name: UN_SC-5 B > Limit unacknowledged data retransmission (IPv6)
#   win_regedit:
#     path: HKLM:\SYSTEM\CurrentControlSet\Services\TCPIP6\Parameters
#     name: TcpMaxDataRetransmissions
#     data: "{{ 3 if undo_UN_SC_5 is not defined else RegistryDefaults.UN_SC_5.B }}"
#     type: dword
#     state: "{{'absent' if (undo_UN_SC_5 is defined and RegistryDefaults.UN_SC_5.B == 4294967295) else 'present'}}"
#   when: skip_UN_SC_5_B is not defined

# - name: UN_SC-5 C > Limit unacknowledged data retransmission
#   win_regedit:
#     path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
#     name: TcpMaxDataRetransmissions
#     data: "{{ 3 if undo_UN_SC_5 is not defined else RegistryDefaults.UN_SC_5.C }}"
#     type: dword
#     state: "{{'absent' if (undo_UN_SC_5 is defined and RegistryDefaults.UN_SC_5.C == 4294967295) else 'present'}}"
#   when: skip_UN_SC_5_B is not defined

# - name: UN_SC-5 D > Set keep-alive packet send interval
#   win_regedit:
#     path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
#     name: KeepAliveTime
#     data: "{{ 300000 if not (undo_UN_SC_5 | default(false)) else RegistryDefaults.UN_SC_5.D }}"
#     type: dword
#     state: "{{'absent' if (undo_UN_SC_5 is defined and RegistryDefaults.UN_SC_5.D == 4294967295) else 'present'}}"
#   when: skip_UN_SC_5_D is not defined

# - name: UN_SC-5 E > Disable IRDP Default Gateway configuration
#   win_regedit:
#     path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
#     name: PerformRouterDiscovery
#     data: "{{ 0 if undo_UN_SC_5 is not defined else RegistryDefaults.UN_SC_5.E }}"
#     type: dword
#     state: "{{'absent' if (undo_UN_SC_5 is defined and RegistryDefaults.UN_SC_5.E == 4294967295) else 'present'}}"
#   when: skip_UN_SC_5_E is not defined