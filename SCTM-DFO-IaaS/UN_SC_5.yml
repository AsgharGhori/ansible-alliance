---
# Called from Windows-Rollback.yml
# Includes all the tasks that fall under
# the Unclassed SC-5 protocol requirements

# Imported vars: RegDefaultsPath RegistryDefaults

- name: UN_SC_5 ? > Check for UN_SC_5 defaults entry
  set_fact:
    HasUNSC5Def: "{{ 'UN_SC_5' in RegistryDefaults }}"

- name: UN_SC_5 = > Get keys if UN_SC_5 is not present
  win_reg_stat:
    path: "{{ item.path }}"
    name: "{{ item.name }}"
  register: UN_SC5_DefKeys
  loop:
    - { taskID: A, path: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU', name: NoAutoRebootWithLoggedOnUsers }
    - { taskID: B, path: 'HKLM:\SYSTEM\CurrentControlSet\Services\TCPIP6\Parameters', name: TcpMaxDataRetransmissions }
    - { taskID: C, path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters', name: TcpMaxDataRetransmissions }
    - { taskID: D, path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters', name: KeepAliveTime }
    - { taskID: E, path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters', name: PerformRouterDiscovery }
  when: not HasUNSC5Def

- name: UN_SC_5 + > Add keys to a dictionary
  set_fact:
    UN_SC_5_Def: "{{ UN_SC_5_Def|default({}) | combine( {item.item.taskID: (item.value if item.exists else -1)} ) }}"
  loop: "{{ UN_SC5_DefKeys.results }}"
  when: not HasUNSC5Def

- name: UN_SC_5 ++ > Add dictionary to RegistryDefaults dictionary
  set_fact:
    RegistryDefaults: "{{ RegistryDefaults | combine({'UN_SC_5':UN_SC_5_Def}) }}"
  when: not HasUNSC5Def

- name: UN_SC_5 IO > Write dictionary
  win_copy:
    dest: "{{ RegDefaultsPath }}"
    content: "{{ RegistryDefaults }}"
  when: not HasUNSC5Def

- name: UN_SC-5 A > Set computer to restart for updates even if user(s) logged in
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
    name: NoAutoRebootWithLoggedOnUsers
    data: "{{ 0 if undo_UN_SC_5 is not defined else RegistryDefaults.UN_SC_5.A }}"
    type: dword
    state: "{{ absent if undo_UN_SC_5 is defined and RegistryDefaults.UN_SC_5.A == -1 else present }}"
  when: skip_UN_SC_5_A is not defined

- name: UN_SC-5 B > Limit unacknowledged data retransmission (IPv6)
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\TCPIP6\Parameters
    name: TcpMaxDataRetransmissions
    data: "{{ 3 if not (undo_UN_SC_5 | default(false)) else RegistryDefaults.UN_SC_5.B }}"
    type: dword
    state: "{{ absent if undo_UN_SC_5 is defined and RegistryDefaults.UN_SC_5.B == -1 else present }}"
  when: skip_UN_SC_5_B is not defined

- name: UN_SC-5 C > Limit unacknowledged data retransmission
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
    name: TcpMaxDataRetransmissions
    data: "{{ 3 if undo_UN_SC_5 is not defined else RegistryDefaults.UN_SC_5.C }}"
    type: dword
    state: "{{ absent if undo_UN_SC_5 is defined and RegistryDefaults.UN_SC_5.C == -1 else present }}"
  when: skip_UN_SC_5_B is not defined

- name: UN_SC-5 D > Set keep-alive packet send interval
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
    name: KeepAliveTime
    data: "{{ 300000 if not (undo_UN_SC_5 | default(false)) else RegistryDefaults.UN_SC_5.D }}"
    type: dword
    state: "{{ absent if undo_UN_SC_5 is defined and RegistryDefaults.UN_SC_5.D == -1 else present }}"
  when: skip_UN_SC_5_D is not defined

- name: UN_SC-5 E > Disable IRDP Default Gateway configuration
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
    name: PerformRouterDiscovery
    data: "{{ 0 if undo_UN_SC_5 is not defined else RegistryDefaults.UN_SC_5.E }}"
    type: dword
    state: "{{ absent if undo_UN_SC_5 is defined and RegistryDefaults.UN_SC_5.E == -1 else present }}"
  when: skip_UN_SC_5_E is not defined