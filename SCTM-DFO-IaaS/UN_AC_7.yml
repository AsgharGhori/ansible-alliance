# == List Script ==
# Includes all the tasks that fall under
# the Unclassed AC-7 protocol requirements

# Expected vars/facts:
# - MachineDefaults {} (populated)
---
# Init task dictionaries
- name: Set AC-7 command task dictionary
  set_fact:
    UN_AC_7_ComTasks:
      - { Desc: Set password attempts before lockout to 5,
        ID: A, Value: 5, Command: 'net accounts /lockoutthreshold:',
        LineIdx: 5, Strip: "Lockout threshold:" } # 0
      - { Desc: Set lockout duration to 60 minutes,
        ID: B, Value: '60', Command: 'net accounts /lockoutduration:',
        LineIdx: 6, Strip: "Lockout duration (minutes):" } # 30
      - { Desc: Set time before password attempts resets to 60 minutes,
        ID: C, Value: 60, Command: 'net accounts /lockoutwindow:',
        LineIdx: 7, Strip: "Lockout observation window (minutes):" } # 30
    UN_AC_7_Diff: "{{ UN_AC_7_ComTasks.1 }}"

# Init and get defaults
- name: Check if defaults for AC-7 were loaded
  set_fact:
    Loaded_UN_AC_7: "{{ 'UN_AC_7' in MachineDefaults }}"

- name: Initialize UndoList
  set_fact:
    UndoList: "{{ UndoList + ['UN_AC_7_'+item.ID] }}"
  loop: "{{ UN_AC_7_ComTasks }}"
  when: "'UN_AC_7' in UndoList"

- name: Get AC-7 network account defaults
  include_tasks: NetAccountDef.yml
  vars:
    SecCat: UN
    TaskCat: AC_7
    ComTasks: "{{ UN_AC_7_ComTasks |difference(UN_AC_7_Diff) }}"
  when: not Loaded_UN_AC_7

# Run tasks
- name: Run AC-7 windows command tasks
  include_tasks: WinCommand.yml
  vars:
    SecCat: UN
    TaskCat: AC_7
  loop: "{{ UN_AC_7_ComTasks }}"
  loop_control:
    loop_var: ComTask

# Failure task
- name: UN_AC_7 B > Set lockout duration to 60 minutes (no undo)
  win_command: 'net accounts /lockoutduration:60'
  when : "'UN_AC_7_B' not in SkipList"