# == List Script ==
# Includes all the tasks that fall under
# the Unclassed AC-3 protocol requirements

# Expected vars/facts:
# - MachineDefaults {} (populated)
---
# Init task dictionaries
- name: Set AC-3 file task dictionaries
  set_fact:
    UN_AC_3_CreateTasks:
    - { Desc: Set 'message of the day' file,
      ID: A, Mode: '600', Path: /etc/motd,
      Content: "\n\t\t   Fisheries and Oceans Canada / Pêches et Océans Canada
      \n\n\t\tUnauthorized Access Prohibited / Accès non-autorisé interdit\n" }
    - { Desc: Set issue file,
      ID: B, Mode: '600', Path: /etc/issue,
      Content: "Ubuntu 18.04.2 LTS \\n \\l" }
    - { Desc: Set issue.net file,
      ID: C, Mode: '600', Path: /etc/issue.net,
      Content: "\t Unauthorized Access Prohibited / Acces non-autorise interdit" }
    UN_AC_3_ChmodTasks:
    - { Desc: Set 'update-motd.d' to access 755,
      ID: AA, Mode: '755', Path: /etc/update-motd.d }

- name: Retrieve file list in /etc/update-motd.d/
  find:
    paths: /etc/update-motd.d
    file_type: file
    recurse: yes
  register: motdfiles

- name: Dynamically append to ChmodTasks dictionary
  set_fact:
    UN_AC_3_ChmodTasks: "{{ UN_AC_3_ChmodTasks + [{
      'Desc': 'Set access mode 644 for file in folder',
      'ID': idx|string, 'Mode': '644', 'Path': item.path }] }}"
  loop: "{{ motdfiles.files }}"
  loop_control:
    index_var: idx

# Init and get defaults
- name: Check if defaults for AC-3 were loaded
  set_fact:
    Loaded_UN_AC_3: "{{ 'UN_AC_3' in MachineDefaults }}"

- name: Initialize UndoList
  set_fact:
    UndoList: "{{ UndoList + ['UN_AC_3_'+item.ID] }}"
  loop: "{{ UN_AC_3_CreateTasks |union(UN_AC_3_ChmodTasks) }}"
  when: "'UN_AC_3' in UndoList"

- name: Get AC-3 file defaults
  include_tasks: TaskScripts/LinuxStat.yml
  vars:
    SecCat: UN
    TaskCat: AC_3
    RegTasks: "{{ UN_AC_3_RegTasks }}"
  when: not Loaded_UN_AC_3

# Run tasks
- name: Run AC-3 create tasks
  include_tasks: TaskScripts/LinuxCreateFile.yml
  vars:
    SecCat: UN
    TaskCat: AC_3
  loop: "{{ UN_AC_3_CreateTasks }}"
  loop_control:
    loop_var: CreateTask

- name: Run AC-3 chmod tasks
  include_tasks: TaskScripts/LinuxChmod.yml
  vars:
    SecCat: UN
    TaskCat: AC_3
  loop: "{{ UN_AC_3_ChmodTasks }}"
  loop_control:
    loop_var: ChmodTask