# == List Script ==
# Includes all the tasks that fall under
# the Unclassed-Low-Low AC-3 protocol requirements

# Expected vars/facts:
# - MachineDefaults {} (populated)
---
# Init task dictionaries
- name: Set AC-3 file task dictionaries
  set_fact:
    ULL_AC_3_ChmodTasks:
    - { Desc: Set 'update-motd.d' to access 755,
      ID: AA, Mode: '755', Path: /etc/update-motd.d }

- name: Retrieve file list in /etc/update-motd.d/
  find:
    paths: /etc/update-motd.d
    file_type: file
    recurse: yes
  register: motdfiles

- name: Dynamically append to ChmodTasks dictionary
  set_fact:
    ULL_AC_3_ChmodTasks: "{{ ULL_AC_3_ChmodTasks + [{
      'Desc': 'Set access mode 644 for file in folder',
      'ID': idx|string, 'Mode': '644', 'Path': item.path }] }}"
  loop: "{{ motdfiles.files }}"
  loop_control:
    index_var: idx

# Init and get defaults
- name: Check if defaults for AC-3 were loaded
  set_fact:
    Loaded_ULL_AC_3: "{{ 'ULL_AC_3' in MachineDefaults }}"

- name: Initialize UndoList
  set_fact:
    UndoList: "{{ UndoList + ['ULL_AC_3_'+item.ID] }}"
  loop: "{{ ULL_AC_3_ChmodTasks }}"
  when: "'ULL_AC_3' in UndoList"

- name: Get AC-3 file status defaults
  include_tasks: TaskScripts/LinuxDefaultStat.yml
  vars:
    SecCat: ULL
    TaskCat: AC_3
    StatTasks: "{{ ULL_AC_3_ChmodTasks }}"
  when: not Loaded_ULL_AC_3

# Run tasks
- name: Run AC-3 chmod tasks
  include_tasks: TaskScripts/LinuxChmod.yml
  vars:
    SecCat: ULL
    TaskCat: AC_3
  loop: "{{ ULL_AC_3_ChmodTasks }}"
  loop_control:
    loop_var: ChmodTask