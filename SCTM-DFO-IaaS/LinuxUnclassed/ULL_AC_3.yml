# == List Script ==
# Includes all the tasks that fall under
# the Unclassed-Low-Low AC-3 protocol requirements

# Expected vars/facts:
# - MachineDefaults {} (populated)
---
# Init task dictionaries
- name: Set AC-3 file task dictionaries
  set_fact:
    ULL_AC_3_ChmodTasks:
    - { Desc: Set 'update-motd.d' permissions to 755,
      ID: A, Path: /etc/update-motd.d, Directory: ,
      Mode: '755', Owner: root, Group: root }
    - { Desc: Set 'update-motd.d' content permissions to 644,
      ID: B, Path: /etc/update-motd.d,  Recurse: ,
      Mode: '644', Owner: root, Group: root }
    - { Desc: Set 'hosts.allow' permissions to 644,
      ID: C, Path: /etc/hosts.allow,
      Mode: '644', Owner: root, Group: root }
    - { Desc: Set 'hosts.deny' permissions to 644,
      ID: D, Path: /etc/hosts.deny,
      Mode: '644', Owner: root, Group: root }
    - { Desc: Set 'crontab' permissions to 600,
      ID: E, Path: /etc/crontab,
      Mode: '600', Owner: root, Group: root }

    - { Desc: Set 'cron.hourly' content permissions to 600,
      ID: F, Path: /etc/cron.hourly, Recurse: ,
      Mode: '600', Owner: root, Group: root }
    - { Desc: Set 'cron.daily' content permissions to 600,
      ID: G, Path: /etc/cron.daily,  Recurse: ,
      Mode: '600', Owner: root, Group: root }
    - { Desc: Set 'cron.weekly' content permissions to 600,
      ID: H, Path: /etc/cron.weekly, Recurse: ,
      Mode: '600', Owner: root, Group: root }
    - { Desc: Set 'cron.monthly' content permissions to 600,
      ID: I, Path: /etc/cron.monthly, Recurse: ,
      Mode: '600', Owner: root, Group: root }
    - { Desc: Set 'cron.d' content permissions to 600,
      ID: F, Path: /etc/cron.d, Recurse: ,
      Mode: '600', Owner: root, Group: root }

    - { Desc: Set 'sshd_config' permissions to 600,
      ID: G, Path: /etc/ssh/sshd_config,
      Mode: '600', Owner: root, Group: root }

    ULL_AC_3_AddLineTasks:
    - { Desc: Restrict use of 'su' to wheel group users,
      ID: T, ToAdd: 'auth required pam_wheel.so' }


# Init and get defaults
- name: Check if defaults for AC-3 were loaded
  set_fact:
    Loaded_ULL_AC_3: "{{ 'ULL_AC_3' in MachineDefaults }}"

- name: Initialize UndoList
  set_fact:
    UndoList: "{{ UndoList + ['ULL_AC_3_'+item.ID] }}"
  loop: "{{ ULL_AC_3_ChmodTasks }}"
  when: "'ULL_AC_3' in UndoList"

- name: Get AC-3 file status defaults
  include_tasks: TaskScripts/LinuxDefaultStat.yml
  vars:
    SecCat: ULL
    TaskCat: AC_3
    StatTasks: "{{ ULL_AC_3_ChmodTasks }}"
  when: not Loaded_ULL_AC_3

# Run tasks
- name: Run AC-3 chmod tasks
  include_tasks: TaskScripts/LinuxChmod.yml
  vars:
    SecCat: ULL
    TaskCat: AC_3
  loop: "{{ ULL_AC_3_ChmodTasks }}"
  loop_control:
    loop_var: ChmodTask