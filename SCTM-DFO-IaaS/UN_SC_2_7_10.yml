---
# Called from Windows-Rollback.yml
# Includes all the tasks that fall under
# the Unclassed UN_SC_2, UN_SC_7, and UN_SC_10 protocol requirements

# Imported vars: RegDefaultsPath RegistryDefaults

- name: UN_SC_2710 ? > Check for UN_SC_2710 defaults entry
  set_fact:
    HasUNSC2710Def: "{{ 'UN_SC_2710' in RegistryDefaults }}"

- name: UN_SC_2710 = > Get keys if UN_SC_2710 is not 'present'
  win_reg_stat:
    path: "{{ item.path }}"
    name: "{{ item.name }}"
  register: UN_SC2710_DefKeys
  loop:
    - { taskID: SC_2, path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip6\Parameters', name: DisableIPSourceRouting }
    - { taskID: SC_7, path: 'HKLM:\SOFTWARE\Policies\Microsoft\MicrosoftEdge\PhishingFilter', name: PreventOverride }
    - { taskID: SC_10, path: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services', name: MaxIdleTime }
  when: not HasUNSC2710Def

- name: UN_SC_2710 + > Add keys to a dictionary
  set_fact:
    UN_SC_2710_Def: "{{ UN_SC_2710_Def|default({}) | combine( {item.item.taskID: (item.value if item.exists else 4294967295)} ) }}"
  loop: "{{ UN_SC2710_DefKeys.results }}"
  when: not HasUNSC2710Def

- name: UN_SC_2710 ++ > Add dictionary to RegistryDefaults dictionary
  set_fact:
    RegistryDefaults: "{{ RegistryDefaults | combine({'UN_SC_2710':UN_SC_2710_Def}) }}"
  when: not HasUNSC2710Def

- name: UN_SC_2710 IO > Write dictionary
  win_copy:
    dest: "{{ RegDefaultsPath }}"
    content: "{{ RegistryDefaults }}"
  when: not HasUNSC2710Def

# UN_SC_2
- name: UN_SC_2 > Prohibit IP source routing
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip6\Parameters
    name: DisableIPSourceRouting
    data: "{{ 2 if undo_UN_SC_2 is not defined else RegistryDefaults.UN_SC_2710.SC_2 }}"
    type: dword
    state: "{{'absent' if (undo_UN_SC_2 is defined and RegistryDefaults.UN_SC_2710.SC_2 == 4294967295) else 'present'}}"
  when: skip_UN_SC_2 is not defined

# UN_SC_7
- name: UN_SC_7 > Prevent bypassing SmartScreen prompts
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\MicrosoftEdge\PhishingFilter
    name: PreventOverride
    data: "{{ 1 if undo_UN_SC_7 is not defined else RegistryDefaults.UN_SC_2710.SC_7 }}"
    type: dword
    state: "{{'absent' if (undo_UN_SC_7 is defined and RegistryDefaults.UN_SC_2710.SC_7 == 4294967295) else 'present'}}"
  when: skip_UN_SC_7 is not defined

# UN_SC_10
- name: UN_SC_10 > Limit idle RDP sessions to 15 mins
  win_regedit:
    path: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services'
    name: MaxIdleTime
    data: "{{ 900000 if undo_UN_SC_10 is not defined else RegistryDefaults.UN_SC_2710.SC_10 }}"
    type: dword
    state: "{{'absent' if (undo_UN_SC_10 is defined and RegistryDefaults.UN_SC_2710.SC_10 == 4294967295) else 'present'}}"
  when: skip_UN_SC_10 is not defined