# Task Script
# Contains Tasks for retrieving and populating the 
# MachineDefaults dictionary with a host's default
# registry keys, and writing that dictionary onto
# the host. Called from a List script

# Expected var(s)/fact(s):
# - MachineDefaults (empty or populated)
# - MachineDefaultsPath
# - SecCat (Security Category, such as UN)
# - TaskCat (Task Category, such as AC_3)
# - RegTasks (one object)
#   - ID
#   - RegPath
#   - RegName
#   - RegType (unused)
#   - Value (unused)
#   - Desc (unused)
---
- name: Set process identifier name
  set_fact:
    ProcessID: "{{SecCat}}_{{TaskCat}}"

- debug:
    var: ProcessID

- name: "Get {{ProcessID}} defaults"
  win_reg_stat:
    path: "{{ item.RegPath }}"
    name: "{{ item.RegName }}"
  register: MachineKeys
  loop: "{{RegTasks}}"

- name: Clear
  set_fact:
    KeyDictionary: {}

- name: Add keys to a dictionary
  set_fact:
    KeyDictionary: "{{KeyDictionary |combine( 
      {item.item.ID: (item.value if item.exists else 4294967295) } 
      )}}"
  loop: "{{MachineKeys.results}}"

- name: Put category defaults in the MachineDefaults dictionary
  set_fact:
    MachineDefaults: "{{MachineDefaults |combine({
      ProcessID:KeyDictionary
    })}}"

- name: Write to MachineDefaults file
  win_copy:
    dest: "{{ MachineDefaultsPath }}"
    content: "{{ MachineDefaults }}"